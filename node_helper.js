/*! *****************************************************************************
  mmm-fuel-nsw
  Version 1.0.0

  A MagicMirrorÂ² module to display fuel prices from New South Wales, Australia.
  Please submit bugs at https://github.com/bughaver/MMM-Fuel-NSW/issues

  (c) [Author]
  Licence: MIT

  This file is auto-generated. Do not edit.
***************************************************************************** */

"use strict";var e=require("node_helper"),t=require("logger");function i(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach(function(i){if("default"!==i){var o=Object.getOwnPropertyDescriptor(e,i);Object.defineProperty(t,i,o.get?o:{enumerable:!0,get:function(){return e[i]}})}}),t.default=e,Object.freeze(t)}var o=i(e),s=i(t);class r{brandMap;constructor(e){this.brandMap=this.createBrandMap(e.brands.items)}mapToFuelStation(e){const t=e.tradinghours?.find(t=>t.Day===e.Day);return{name:e.Name,brand:e.Brand,location:this.extractLocationName(e.Name,e.Brand,e.Address),address:this.normalizeAddress(e.Address),price:e.Price,distance:e.Distance,fieldType:e.FuelType,isOpenNow:t?.IsOpenNow??!1,isClosingSoon:this.isClosingSoon(t),logoUrl:this.brandMap.get(e.Brand)}}createBrandMap(e){const t=new Map;return e.forEach(e=>{e.isactive&&t.set(e.description,e.logoimageurl)}),t}extractLocationName(e,t,i){let o=e;if(t){const e=t.toLowerCase(),i=o.toLowerCase();if(i.startsWith(e))o=o.substring(t.length).trim(),(o.startsWith("-")||o.startsWith("/"))&&(o=o.substring(1).trim());else{const t=e.split(" ")[0];if(i.startsWith(t+" ")){const e=i.substring(t.length+1),s=["petrol","fuel","service","roadhouse","express"];let r=-1;for(const i of s){const o=e.toLowerCase().indexOf(i.toLowerCase());if(-1!==o){const s=e.indexOf(" ",o+i.length);r=t.length+1+(-1===s?e.length:s);break}}r>0&&r<i.length&&(o=o.substring(r).trim(),(o.startsWith("-")||o.startsWith("/"))&&(o=o.substring(1).trim()))}}}if(i){const e=this.normalizeAddress(i),t=this.combineNameAndAddress(o,e);return this.toPascalCase(t)}return this.toPascalCase(o)}combineNameAndAddress(e,t){let i=t.match(/,\s*([^,]+)\s+NSW\s+\d{4}/i),o=i?i[1].trim():"";if(!o&&(i=t.match(/(\w+(?:\s+\w+)*)\s+NSW\s+\d{4}/i),i)){const e=i[1].trim().split(/\s+/);let t="";const s=e[e.length-1];if(!s||/\d/.test(s)||/^(road|street|avenue|drive|place|lane|way|highway|close|court|terrace|parade|grove|hill|circuit|boulevard)$/i.test(s)||(t=s),e.length>=2){const i=e[e.length-2];/^(north|south|east|west|central|inner|outer|upper|lower)$/i.test(i)&&(t=`${i} ${s}`)}o=t||s}if(!o)return e.replace(/\s*\([^)]*\)\s*/g,"").trim();const s=e.replace(/\s*\([^)]*\)\s*/g,"").trim(),r=o.toLowerCase(),a=s.toLowerCase();if(a.includes(r)){const e=a.indexOf(r)+r.length,t=s.substring(e).trim().match(/^\s*(north|south|east|west)\b/i);return t?`${o} ${t[1].charAt(0).toUpperCase()+t[1].slice(1).toLowerCase()}`:o}return s.toLowerCase().includes("park")||s.toLowerCase().includes("point")||s.toLowerCase().includes("beach")||s.toLowerCase().includes("centre")||s.toLowerCase().includes("center")||s.toLowerCase().includes("avenue")||s.toLowerCase().includes("street")||s.toLowerCase().includes("road")||s.toLowerCase().includes("drive")||s.toLowerCase().includes("place")||s.toLowerCase().includes("lane")||s.toLowerCase().includes("way")||s.toLowerCase().includes("highway")||s.toLowerCase().includes("bay")||s.toLowerCase().includes("cove")||s.toLowerCase().includes("hill")||s.toLowerCase().includes("mountain")||s.toLowerCase().includes("valley")||s.toLowerCase().includes("ridge")||s.toLowerCase().includes("heights")||s.toLowerCase().includes("downs")||s.toLowerCase().includes("estate")||s.toLowerCase().includes("village")||s.toLowerCase().includes("crossing")||s.toLowerCase().includes("junction")||s.toLowerCase().includes("corner")?s:o}toPascalCase(e){return e.toLowerCase().split(/\s+/).map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ").trim()}isClosingSoon(e){if(!e||e.IsOpen24Hours)return!1;const t=this.parseTime(e.EndTime),i=new Date,o=t.getTime()-i.getTime();return o>0&&o<=36e5}parseTime(e){const[t,i]=e.split(" ");let[o,s]=t.split(":").map(Number);"PM"===i&&12!==o&&(o+=12),"AM"===i&&12===o&&(o=0);const r=new Date;return new Date(r.getFullYear(),r.getMonth(),r.getDate(),o,s)}normalizeAddress(e){if(!e)return"";let t=e;t=t.replace(/,+\s*,+/g,","),t=t.replace(/\s*,\s*/,", "),t=t.replace(/\s+/g," ").trim(),t=t.toLowerCase().split(" ").map(e=>{const t=e.toLowerCase();return"nsw"===t||"act"===t||"qld"===t||"wa"===t||"sa"===t||"nt"===t||"tas"===t||"vic"===t?e.toUpperCase():e.charAt(0).toUpperCase()+e.slice(1)}).join(" ");return Object.entries({rd:"Road",st:"Street",ave:"Avenue",av:"Avenue",dr:"Drive",ct:"Court",pl:"Place",ln:"Lane",way:"Way",hwy:"Highway",hw:"Highway",cres:"Crescent",cl:"Close",pde:"Parade",sq:"Square",terr:"Terrace",bvd:"Boulevard",cir:"Circle",gr:"Grove",hill:"Hill"}).forEach(([e,i])=>{const o=new RegExp(`\\b${e}\\b`,"gi");t=t.replace(o,i)}),t=t.replace(/\bcnr\b/gi,"Corner"),t=t.replace(/\b&\b/g,"&"),t}}class a{backendService;constructor(e){this.backendService=e}async getValidatedFuelStations(e){const t=await this.backendService.validateConfig(e);if(!t.isValid)throw new Error(`Configuration validation failed: ${t.errors.join(", ")}`);const i=this.calculateBoundingBox(e),o=await this.backendService.fetchFuelStationsByLocation(e.fuelType,e.brands,i),s=await this.backendService.fetchReferenceData(),a=new r(s);let n=o.map(e=>a.mapToFuelStation(e));return n=this.applyFilters(n,e),n}calculateBoundingBox(e){if(void 0!==e.lat&&void 0!==e.long)return this.createBoundingBoxFromCenter(e.lat,e.long,e.radius);if(this.hasCompleteBoundingBox(e))return{bottomLeftLatitude:e.bottomLeftLatitude,bottomLeftLongitude:e.bottomLeftLongitude,topRightLatitude:e.topRightLatitude,topRightLongitude:e.topRightLongitude};throw new Error("Invalid location configuration: must provide either lat/long or complete bounding box")}createBoundingBoxFromCenter(e,t,i){const o=i/111,s=i/(111*Math.cos(e*Math.PI/180));return{bottomLeftLatitude:e-o,bottomLeftLongitude:t-s,topRightLatitude:e+o,topRightLongitude:t+s}}hasCompleteBoundingBox(e){return!(void 0===e.bottomLeftLatitude||void 0===e.bottomLeftLongitude||void 0===e.topRightLatitude||void 0===e.topRightLongitude)}applyFilters(e,t){let i=[...e];return i.sort((e,i)=>"distance"===t.sortBy?e.distance-i.distance:e.price-i.price),void 0!==t.distance&&(i=i.filter(e=>e.distance<=t.distance)),void 0!==t.limit&&(i=i.slice(0,t.limit)),i}}class n{baseUrl="https://www.fuelcheck.nsw.gov.au/fuel/api/v1/fuel";async fetchReferenceData(){const e=await fetch(`${this.baseUrl}/refData`);if(!e.ok)throw new Error(`Failed to fetch reference data: ${e.status}`);return e.json()}async fetchFuelStationsByLocation(e,t,i){const o=new URLSearchParams({fuelType:e,brands:0===t.length?"SelectAll":t.join("|"),bottomLeftLatitude:i.bottomLeftLatitude.toString(),bottomLeftLongitude:i.bottomLeftLongitude.toString(),topRightLatitude:i.topRightLatitude.toString(),topRightLongitude:i.topRightLongitude.toString()}),s=await fetch(`${this.baseUrl}/prices/bylocation?${o}`);if(!s.ok)throw new Error(`Failed to fetch fuel stations: ${s.status}`);return s.json()}async validateConfig(e){const t=[];try{const i=await this.fetchReferenceData(),o=e.fuelType??"P95";new Set(i.fueltypes.items.filter(e=>e.isactive).map(e=>e.code)).has(o)||t.push(`Invalid fuel type: ${o}`);const s=e.brands??[];if(s.length>0){const e=new Set(i.brands.items.filter(e=>e.isactive).map(e=>e.description)),o=s.filter(t=>!e.has(t));o.length>0&&t.push(`Invalid brands: ${o.join(", ")}`)}}catch(e){t.push(`API validation failed: ${e}`)}return{isValid:0===t.length,errors:t}}async getFuelStations(e){return new a(this).getValidatedFuelStations(e)}}module.exports=o.create({backendService:null,start(){s.log(`${this.name} helper method started...`),this.backendService=new n},async socketNotificationReceived(e,t){if(e.includes("FUEL_REQUEST")){const i=e.substring(13);try{if(!this.backendService)throw new Error("Backend service not initialized");const e=await this.backendService.getFuelStations(t),o={lastUpdate:Date.now(),stations:e};this.sendSocketNotification(`FUEL_RESPONSE-${i}`,o)}catch(e){s.error("Error fetching fuel prices:",e);const t={lastUpdate:Date.now(),stations:[]};this.sendSocketNotification(`FUEL_RESPONSE-${i}`,t)}}else s.warn(`${e} is invalid notification`)}});
