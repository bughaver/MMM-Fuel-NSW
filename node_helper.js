/*! *****************************************************************************
  mmm-fuel-nsw
  Version 1.0.0

  A MagicMirrorÂ² module to display fuel prices from New South Wales, Australia.
  Please submit bugs at https://github.com/bughaver/MMM-Fuel-NSW/issues

  (c) [Author]
  Licence: MIT

  This file is auto-generated. Do not edit.
***************************************************************************** */
"use strict";var t=require("node_helper"),e=require("logger");function i(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach(function(i){if("default"!==i){var r=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(e,i,r.get?r:{enumerable:!0,get:function(){return t[i]}})}}),e.default=t,Object.freeze(e)}var r=i(t),s=i(e);class a{static async validateConfigWithReferenceData(t,e){const i=[],r=void 0!==t.lat&&void 0!==t.long,s=void 0!==t.bottomLeftLatitude&&void 0!==t.bottomLeftLongitude&&void 0!==t.topRightLatitude&&void 0!==t.topRightLongitude;r||s?r&&s&&i.push("Cannot provide both lat/long and bounding box coordinates"):i.push("Must provide either lat/long or complete bounding box coordinates");if(new Set(e.fueltypes.items.filter(t=>t.isactive).map(t=>t.code)).has(t.fuelType)||i.push(`Invalid fuel type: ${t.fuelType}`),t.brands.length>0&&!t.brands.includes("SelectAll")){const r=new Set(e.brands.items.filter(t=>t.isactive).map(t=>t.description)),s=t.brands.filter(t=>!r.has(t));s.length>0&&i.push(`Invalid brands: ${s.join(", ")}`)}return{isValid:0===i.length,errors:i}}}class o{backendRepository;constructor(t){this.backendRepository=t}async validateConfig(t){try{const e=await this.backendRepository.getReferenceData();return await a.validateConfigWithReferenceData(t,e)}catch(t){return{isValid:!1,errors:[`API validation failed: ${t}`]}}}async getFuelStations(t){const e=await this.validateConfig(t);if(!e.isValid)throw new Error(`Configuration validation failed: ${e.errors.join(", ")}`);return await this.backendRepository.getFuelStations(t)}}class n{static calculateBoundingBox(t){if(void 0!==t.lat&&void 0!==t.long)return this.createBoundingBoxFromCenter(t.lat,t.long,t.radius);if(this.hasCompleteBoundingBox(t))return{bottomLeftLatitude:t.bottomLeftLatitude,bottomLeftLongitude:t.bottomLeftLongitude,topRightLatitude:t.topRightLatitude,topRightLongitude:t.topRightLongitude};throw new Error("Invalid location configuration: must provide either lat/long or complete bounding box")}static createBoundingBoxFromCenter(t,e,i){const r=i/111,s=i/(111*Math.cos(t*Math.PI/180));return{bottomLeftLatitude:t-r,bottomLeftLongitude:e-s,topRightLatitude:t+r,topRightLongitude:e+s}}static hasCompleteBoundingBox(t){return!(void 0===t.bottomLeftLatitude||void 0===t.bottomLeftLongitude||void 0===t.topRightLatitude||void 0===t.topRightLongitude)}}class c{backendMapper;fuelApiConnector;constructor(t,e){this.backendMapper=t,this.fuelApiConnector=e}async getReferenceData(){return this.fuelApiConnector.fetchReferenceData()}async getFuelStations(t){const e=await this.fuelApiConnector.fetchReferenceData(),i=this.processConfigForApi(t);let r=(await this.fetchFuelStations(i)).map(t=>this.backendMapper.mapToFuelStation(t,e.brands.items));return r=this.applyFilters(r,i),r}processConfigForApi(t){const e={...t};return 0===e.brands.length&&(e.brands=["SelectAll"]),e}async fetchFuelStations(t){const e=n.calculateBoundingBox(t);return await this.fuelApiConnector.fetchFuelStationsByLocation(t.fuelType,t.brands,e)}applyFilters(t,e){let i=[...t];return e.brands.length>0&&!e.brands.includes("SelectAll")&&(i=i.filter(t=>e.brands.includes(t.brand))),i.sort((t,i)=>"distance"===e.sortBy?t.distance-i.distance:t.price-i.price),void 0!==e.distance&&(i=i.filter(t=>t.distance<=e.distance)),void 0!==e.limit&&(i=i.slice(0,e.limit)),i}}class l{static STATE_ABBREVIATIONS=new Set(["nsw","act","qld","wa","sa","nt","tas","vic"]);static ROAD_ABBREVIATIONS={rd:"Road",st:"Street",ave:"Avenue",av:"Avenue",dr:"Drive",ct:"Court",pl:"Place",ln:"Lane",way:"Way",hwy:"Highway",hw:"Highway",cres:"Crescent",cl:"Close",pde:"Parade",sq:"Square",terr:"Terrace",bvd:"Boulevard",cir:"Circle",gr:"Grove",hill:"Hill"};static normalizeAddress(t){if(!t)return"";let e=t;return e=e.replace(/,+\s*,+/g,","),e=e.replace(/\s*,\s*/,", "),e=e.replace(/\s+/g," ").trim(),e=this.applyProperCapitalization(e),e=e.replace(/\bcnr\b/gi,"Corner"),e=e.replace(/\b&\b/g,"&"),e}static extractSuburbFromAddress(t){if(!t)return"";let e=t.match(/,\s*([^,]+)\s+NSW\s+\d{4}/i),i=e?e[1].trim():"";if(!i&&(e=t.match(/(\w+(?:\s+\w+)*)\s+NSW\s+\d{4}/i),e)){const t=e[1].trim().split(/\s+/);i=this.extractSuburbCandidate(t)}return i}static extractSuburbCandidate(t){const e=t[t.length-1];if(e&&!/\d/.test(e)&&!this.isRoadType(e)){let i=e;if(t.length>=2){const r=t[t.length-2];this.isDirection(r)&&(i=`${r} ${e}`)}return i}return e||""}static isDirection(t){const e=t.toLowerCase();return/^(north|south|east|west|central|inner|outer|upper|lower)$/i.test(e)}static isRoadType(t){const e=t.toLowerCase();return/^(road|street|avenue|drive|place|lane|way|highway|close|court|terrace|grove|hill|circuit|boulevard)$/i.test(e)}static applyProperCapitalization(t){let e=t.toLowerCase();return Object.entries(this.ROAD_ABBREVIATIONS).forEach(([t,i])=>{const r=new RegExp(`\\b${t}\\b`,"gi");e=e.replace(r,i)}),e=e.split(" ").map(t=>{const e=t.toLowerCase();return this.STATE_ABBREVIATIONS.has(e)?t.toUpperCase():t.charAt(0).toUpperCase()+t.slice(1)}).join(" "),e}}class d{static LOCATION_KEYWORDS=new Set(["park","point","beach","centre","center","avenue","street","road","drive","place","lane","way","highway","bay","cove","hill","mountain","valley","ridge","heights","downs","estate","village","crossing","junction","corner"]);static BRAND_SUFFIXES=["petrol","fuel","service","roadhouse","express"];static removeBrandPrefix(t,e){if(!e)return t;const i=e.toLowerCase(),r=t.toLowerCase();if(r.startsWith(i))return this.cleanLeadingSeparators(t.substring(e.length));const s=i.split(" ")[0];if(r.startsWith(s+" ")){const e=r.substring(s.length+1);for(const i of this.BRAND_SUFFIXES){const a=e.toLowerCase().indexOf(i.toLowerCase());if(-1!==a){const o=e.indexOf(" ",a+i.length),n=s.length+1+(-1===o?e.length:o);if(n>0&&n<r.length)return this.cleanLeadingSeparators(t.substring(n));break}}}return t}static combineNameAndAddress(t,e){const i=this.extractSuburbFromAddress(e);if(!i)return t.replace(/\s*\([^)]*\)\s*/g,"").trim();const r=t.replace(/\s*\([^)]*\)\s*/g,"").trim(),s=i.toLowerCase(),a=r.toLowerCase();if(a.includes(s)){const t=a.indexOf(s)+s.length,e=r.substring(t).trim().match(/^\s*(north|south|east|west)\b/i);if(e){return`${i} ${e[1].charAt(0).toUpperCase()+e[1].slice(1).toLowerCase()}`}return i}return this.seemsLikeLocationName(r)?r:i}static toPascalCase(t){return t.toLowerCase().split(/\s+/).map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ").trim()}static seemsLikeLocationName(t){const e=t.toLowerCase();return Array.from(this.LOCATION_KEYWORDS).some(t=>e.includes(t))}static extractSuburbFromAddress(t){if(!t)return"";let e=t.match(/,\s*([^,]+)\s+NSW\s+\d{4}/i),i=e?e[1].trim():"";if(!i&&(e=t.match(/(\w+(?:\s+\w+)*)\s+NSW\s+\d{4}/i),e)){const t=e[1].trim().split(/\s+/);i=this.extractSuburbCandidate(t)}return i}static extractSuburbCandidate(t){const e=t[t.length-1];if(e&&!/\d/.test(e)&&!this.isRoadType(e)){let i=e;if(t.length>=2){const r=t[t.length-2];this.isDirection(r)&&(i=`${r} ${e}`)}return i}return e||""}static isDirection(t){const e=t.toLowerCase();return/^(north|south|east|west|central|inner|outer|upper|lower)$/i.test(e)}static isRoadType(t){const e=t.toLowerCase();return/^(road|street|avenue|drive|place|lane|way|highway|close|court|terrace|grove|hill|circuit|boulevard)$/i.test(e)}static cleanLeadingSeparators(t){return t.replace(/^[-/]\s*/,"")}}class u{static parseTime(t,e=new Date){const[i,r]=t.split(" ");let[s,a]=i.split(":").map(Number);return"PM"===r&&12!==s&&(s+=12),"AM"===r&&12===s&&(s=0),new Date(e.getFullYear(),e.getMonth(),e.getDate(),s,a)}static isClosingSoon(t,e=new Date){if(!t||t.IsOpen24Hours)return!1;const i=this.parseTime(t.EndTime,e).getTime()-e.getTime();return i>0&&i<=36e5}}class h{static getLogoUrl(t,e){const i=t.find(t=>t.isactive&&t.description===e);return i?.logoimageurl}}class p{addressUtils;locationUtils;timeUtils;constructor(){this.addressUtils=l,this.locationUtils=d,this.timeUtils=u}mapToFuelStation(t,e,i=new Date){const r=t.tradinghours?.find(e=>e.Day===t.Day),s=h.getLogoUrl(e,t.Brand);return{name:t.Name,brand:t.Brand,location:this.extractLocationName(t.Name,t.Address,t.Brand),address:this.addressUtils.normalizeAddress(t.Address),price:t.Price,distance:t.Distance,fieldType:t.FuelType,isOpenNow:r?.IsOpenNow??!1,isClosingSoon:this.timeUtils.isClosingSoon(r,i),logoUrl:s}}extractLocationName(t,e,i){const r=this.locationUtils.removeBrandPrefix(t,i),s=this.addressUtils.normalizeAddress(e),a=this.locationUtils.combineNameAndAddress(r,s),o=this.locationUtils.toPascalCase(a),n=this.locationUtils.toPascalCase(r);return o!==n?o:n}}class g{baseUrl="https://www.fuelcheck.nsw.gov.au/fuel/api/v1/fuel";async fetchReferenceData(){const t=await fetch(`${this.baseUrl}/refData`);if(!t.ok)throw new Error(`Failed to fetch reference data: ${t.status}`);return t.json()}async fetchFuelStationsByLocation(t,e,i){const r=new URLSearchParams({fuelType:t,brands:e.join("|"),bottomLeftLatitude:i.bottomLeftLatitude.toString(),bottomLeftLongitude:i.bottomLeftLongitude.toString(),topRightLatitude:i.topRightLatitude.toString(),topRightLongitude:i.topRightLongitude.toString()}),s=await fetch(`${this.baseUrl}/prices/bylocation?${r}`);if(!s.ok)throw new Error(`Failed to fetch fuel stations: ${s.status}`);return s.json()}}module.exports=r.create({backendService:null,async start(){s.log(`${this.name} helper method started...`);const t=new g,e=new p,i=new c(e,t);this.backendService=new o(i)},async socketNotificationReceived(t,e){if(t.includes("FUEL_REQUEST")){const i=t.substring(13);try{if(!this.backendService)throw new Error("Backend service not initialized");const t=await this.backendService.getFuelStations(e),r={lastUpdate:Date.now(),stations:t};this.sendSocketNotification(`FUEL_RESPONSE-${i}`,r)}catch(t){s.error("Error fetching fuel prices:",t);const e={lastUpdate:Date.now(),stations:[]};this.sendSocketNotification(`FUEL_RESPONSE-${i}`,e)}}else s.warn(`${t} is invalid notification`)}});
